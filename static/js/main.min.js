"use strict";const colorStart="4b8219",colorAlert="e0970f",colorOver="950000",warnline=.7,headFitRate=.4,descFitRate=.35,tableContainer=$(".date-grid");let screenDirection;const sampleData={year:2018,month:10,monthStartDate:10,monthMaxDate:31,dayLimit:100,monthLimit:9400,display:{default:{head:"{date} <small>{weekday}</small>",custHead:"{name}",custDesc:"￥{out:.2f} <small>+ {in:.2f}</small> | ￥{total:.2f}"},portrait:{desc:"￥{out:d}"},landscape:{head:"{month}.{date} <small>{fullweekday}</small>",desc:"￥{out:.2f} <small>+ {in:.2f}</small>"}},billings:[{createDate:"2018-10-11T15:08:00+08:00",title:"Uber Home - Corp",cashOut:"33.6",type:"Transit",payment:"Alipay - Huabei",date:{year:2018,month:10,day:10}},{createDate:"2018-10-11T15:08:00+08:00",title:"DaXiangChang and Choudoufu",cashOut:"43",type:"Eat",payment:"CCB(6968)",date:{year:2018,month:10,day:10}},{createDate:"2018-10-11T15:08:00+08:00",title:"Chuanchuan",cashOut:"39.5",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:10}},{createDate:"2018-10-11T15:08:00+08:00",title:"Gongcha",cashOut:"25",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:10}},{createDate:"2018-10-11T15:08:00+08:00",title:"Nanjing Dapaidang",cashOut:"132",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:10}},{createDate:"2018-10-11T15:08:00+08:00",title:"Cloth",cashOut:"1018.58",type:"Cloth",belongsTo:"others",payment:"Alipay - Huabei"},{createDate:"2018-10-11T15:08:00+08:00",title:"Uber Home - Corp",cashOut:"31.78",type:"Transit",payment:"Alipay - Huabei",date:{year:2018,month:10,day:11}},{createDate:"2018-10-12T17:08:00+08:00",title:"Changfen",cashOut:"28",type:"Eat",payment:"CCB(6968)",date:{year:2018,month:10,day:11}},{createDate:"2018-10-12T17:08:00+08:00",title:"Douhua",cashOut:"15",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:11}},{createDate:"2018-10-12T17:08:00+08:00",title:"Baodan",cashOut:"10",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:11}},{createDate:"2018-10-12T17:08:00+08:00",title:"Jianfen",cashOut:"18",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:11}},{createDate:"2018-10-12T17:08:00+08:00",title:"Chaoshi",cashOut:"9",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:12}},{createDate:"2018-10-11T15:08:00+08:00",title:"Uber Home - Corp",cashOut:"34.44",type:"Transit",payment:"Alipay - Huabei",date:{year:2018,month:10,day:12}},{createDate:"2018-10-12T17:08:00+08:00",title:"Mutong Sanguo",cashOut:"29",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:12}},{createDate:"2018-10-12T17:08:00+08:00",title:"Xianguo Haji",cashOut:"20",type:"Eat",payment:"Alipay - Huabei",date:{year:2018,month:10,day:12}},{createDate:"2018-10-12T17:08:00+08:00",title:"Laifenqi",cashOut:"266.94",type:"Eat",payment:"CCB(6968)",belongsTo:"others"},{createDate:"2018-10-12T17:08:00+08:00",title:"Cloth",cashOut:"350",type:"Eat",payment:"CCB(6968)",belongsTo:"others"},{createDate:"2018-10-12T17:08:00+08:00",title:"Credit Card Back Guangfa",cashOut:"320",type:"Credit Card",payment:"CCB(6968)",belongsTo:"others"},{createDate:"2018-10-12T17:08:00+08:00",title:"Credit Card Back Zhongxin",cashOut:"1000",type:"Credit Card",payment:"CCB(6968)",belongsTo:"others"}],customCard:[{name:"OTHER",owner:"others",isFull:!0,limit:"$MIN($MONTH_LIMIT-$CASHOUT_TOTAL, 3000)",cashIn:{func:"sum",fields:"cashIn"},cashOut:{func:"sum",fields:"cashOut"}},{name:"TOTAL",isFull:!0,limit:"$MONTH_LIMIT+$CASHIN_TOTAL",cashIn:{func:"sum",fields:"cashIn"},cashOut:{func:"sum",fields:"cashOut"},display:{head:"TOTAL"}}]};var viewdata={},utils={},funcs={},events={};utils.calc=function(exp){return new Function("var dom = {}; var __ = {}; var utils = {}; var json = {}; return "+exp)()},utils.pad=function(num){return num<10?"0"+num:""+num},utils.convertNumber=function(number,format){var m=/\{[^:{}]+:?([^:{}]*?)\}/g.exec(format);if(null!==m){if("d"===m[1])return parseInt(number);var n=/\.(\d+)f/g.exec(m);if(null!==n){var decilen=parseInt(n[1]);return parseFloat(number).toFixed(decilen)}}},utils.splitDate=function(dateStr){return"string"!=typeof dataStr||8!=dateStr.length?[0,1,1]:[parseInt(dateStr.substr(0,4)),parseInt(dateStr.substr(4,2)),parseInt(dateStr.substr(6,2))]},funcs.buildCardsData=function(json){var $defs={MAX:function(a,b){return a>b?a:b},MIN:function(a,b){return a<b?a:b}};$defs.MONTH_LIMIT=json.monthLimit,$defs.MONTH=json.month,$defs.YEAR=json.year,$defs.START_DATE=json.monthStartDate,$defs.MAX_DATE=json.monthMaxDate,$defs.WEEKDAY_NAMES=["日","月","火","水","木","金","土"],$defs.WEEKDAY_FULLNAMES=["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"];$defs.MAX,$defs.MIN,$defs.MONTH_LIMIT,$defs.YEAR,$defs.MONTH,$defs.START_DATE,$defs.MAX_DATE;var __={cards:[],display:{portrait:Object.assign({},json.display.default,json.display.portrait),landscape:Object.assign({},json.display.default,json.display.landscape)},applyTemplate:function(tpl,vd){return tpl.replace(/\{year\}/g,vd.date.getFullYear()||0).replace(/\{month\}/g,vd.date.getMonth()+1||0).replace(/\{(week)?day\}/g,$defs.WEEKDAY_NAMES[vd.date.getDay()]||"undefined").replace(/\{full(week)?day\}/g,$defs.WEEKDAY_FULLNAMES[vd.date.getDay()]||"undefined").replace(/\{date\}/g,vd.date.getDate()||"undefined").replace(/\{name\}/,vd.conf.name)},buildCard:function(key,isCustom,viewdata,firstRecord){var fr=firstRecord||{undefined:!0};return{list:fr[void 0]?[]:[fr],srcKey:key,isCustom:isCustom,cashIn:fr.cashIn||0,cashOut:fr.cashOut||0,limit:json.dayLimit||0,head_port:__.applyTemplate(isCustom?__.display.portrait.custHead:__.display.portrait.head,viewdata),desc_port:__.applyTemplate(isCustom?__.display.portrait.custDesc:__.display.portrait.desc,viewdata),head_land:__.applyTemplate(isCustom?__.display.landscape.custHead:__.display.landscape.head,viewdata),desc_land:__.applyTemplate(isCustom?__.display.landscape.custDesc:__.display.landscape.desc,viewdata)}}},days=[...Array($defs.MAX_DATE+1).keys()].splice($defs.START_DATE),days_=[...Array($defs.START_DATE).keys()].splice(1),keys=days.map(function(x){return[$defs.YEAR,$defs.MONTH,x].join("/")}).concat(days_.map(function(x){return[$defs.YEAR,$defs.MONTH+1,x].join("/")}));for(var i in keys){var key=keys[i],viewdata={conf:{},date:new Date(key)},c=__.buildCard(key,!1,viewdata);__.cards[key]=c}for(var i in json.billings){var b=json.billings[i],isCustom=(key="",!1);if((viewdata={}).date=new Date(b.year,b.month-1,b.day,0,0,0,0),"belongsTo"in b)key=b.belongsTo,isCustom=!0,viewdata.conf=json.customCard.find(function(x){return x.owner===key});else{if(!("date"in b)){console.log("Skipped a invalid data. a billing record should contains either `belongsTo` or `date`.");continue}key=[b.date.year,b.date.month,b.date.day].join("/"),viewdata.conf={}}var ori=__.cards[key];ori?funcs.insertRecord(__.cards,b):(ori=__.buildCard(key,isCustom,viewdata,b),__.cards[key]=ori)}return __.cards},funcs.updateData=function(e,json,conf){var __={},el=$(e);if(json){if(el.hasClass(".grid-cell")?(__.cntel=el,el=el.children(".card")):__.cntel=$(el).parents(".grid-cell"),0===__.cntel.length){var $el=$('<div class="grid-cell"></div>');tableContainer.append($el),__.cntel=$el}if(__.el=__.cntel.children(".card"),0===__.el.length){$el=$('<div class="card"></div>');__.cntel.append($el),conf&&conf.disabled?$el.addClass("disabled"):conf&&!conf.disabled&&$el.removeClass("disabled"),__.el=$el}__.applyTemplate=function(tpl){return tpl.replace(/\{in\:?.*?\}/g,function(x){return utils.convertNumber(json.cashIn,x)}).replace(/\{out\:?.*?\}/g,function(x){return utils.convertNumber(json.cashOut,x)}).replace(/\{total\:?.*?\}/g,function(x){return utils.convertNumber(json.cashOut-json.cashIn,x)})},__.el.attr("data-key",json.srcKey),__.el.attr("data-limit",json.limit),__.el.attr("data-in",json.cashIn),__.el.attr("data-out",json.cashOut),__.dir=__.el.attr("data-direction"),__.disabled=__.el.hasClass("disabled"),"|"===__.dir?(__.el.attr("data-head",__.applyTemplate(json.head_port)),__.el.attr("data-desc",__.disabled?"":__.applyTemplate(json.desc_port))):"-"===__.dir&&(__.el.attr("data-head",__.applyTemplate(json.head_land)),__.el.attr("data-desc",__.disabled?"":__.applyTemplate(json.desc_land))),__.el.attr("data-changed","true")}},funcs.insertRecord=function(carddata,json){var $obj=Object.assign({createDate:(new Date).toISOString(),title:"",type:"",payment:""},json);let key;if("belongsTo"in $obj)key=$obj.belongsTo;else{if(!("date"in $obj))throw{data:{desc:"重要な部分`belongsTo`と`date`の中にいずれは必ず指定する。"},toString:function(){return"新しく入力されたレコードは無効なテーターとなっている。"}};key=[$obj.date.year,$obj.date.month,$obj.date.day].join("/")}var item=carddata[key];if(!item)throw{data:{desc:"カードデーターに"+key+"がキーとなるデーターが存在しない。"},toString:function(){return"新しく入力されたレコードは無効なテーターとなっている。"}};item.list.push($obj),item.cashOut+=parseFloat($obj.cashOut)||0,item.cashIn+=parseFloat($obj.cashIn)||0},funcs.removeRecord=function(carddata,key,i){var item=carddata[key];if(!item)throw{data:{desc:"カードデーターに"+key+"がキーとなるデーターが存在しない。"},toString:function(){return"削除失敗。"}};var b=item.list[i];if(!b)throw{data:{desc:i+"がインデックスとなるデーターが存在しない。"},toString:function(){return"削除失敗。"}};return item.cashOut-=parseFloat(b.cashOut)||0,item.cashIn-=parseFloat(b.cashIn)||0,carddata[key].list.splice(i,1)},utils.gradient=function(color1,color2,ratio){var hex=function(x){return 1==(x=x.toString(16)).length?"0"+x:x},r=Math.ceil(parseInt(color2.substring(0,2),16)*ratio+parseInt(color1.substring(0,2),16)*(1-ratio)),g=Math.ceil(parseInt(color2.substring(2,4),16)*ratio+parseInt(color1.substring(2,4),16)*(1-ratio)),b=Math.ceil(parseInt(color2.substring(4,6),16)*ratio+parseInt(color1.substring(4,6),16)*(1-ratio));return hex(r)+hex(g)+hex(b)},utils.calcColor=function(ratio){return ratio<0?utils.calcColor(0):ratio>1?utils.calcColor(1):ratio<.7?"#"+utils.gradient("4b8219","4b8219",ratio/.7*.5):"#"+utils.gradient("e0970f","950000",.5/(1-.7)*(ratio-.7)*2)},utils.meatureCard=function(e){var el=$(e),hig=el.outerHeight(),wid=el.outerWidth(),predir=el.attr("data-direction");el.attr("data-direction",2*hig>wid?"|":"-"),predir!==el.attr("data-direction")&&events.cardDirectionChanged(el)},utils.meatureDoc=function(){var wid=$(window).width(),hig=$(window).height();(screenDirection=hig>wid?"|":"-")&&events.screenDirectionChanged()},events.cardDirectionChanged=function(el){var key=el.attr("data-key"),json=viewdata[key];funcs.updateData(el,json),funcs.updateView(el),funcs.updateContent(el)},funcs.updateView=function(el){if(!(el=$(el)).hasClass("disabled")){var cashin=parseFloat(el.attr("data-in"))||0,value=(parseFloat(el.attr("data-out"))||0)-cashin||parseInt(el.attr("data-value"));("number"!=typeof value||isNaN(value))&&(value=0);var ratio=value/parseInt(el.attr("data-limit"));ratio>1&&(ratio=1),ratio<0&&(ratio=0),funcs.drawColorBar(el,ratio)}},funcs.drawColorBar=function(el,ratio){var e=$(el),cb=e.children(".colorbar"),rt=parseFloat(cb.attr("data-ratio")),dir=e.attr("data-direction"),bardir=cb.attr("data-direction");if(ratio!==rt||bardir!==dir){if(0==cb.length){var $cb=$('<div class="colorbar"></div>');e.append($cb),cb=$cb}var color=utils.calcColor(ratio);e.css({"border-color":color}),e.css({"background-color":color}),"-"==dir?cb.css({right:100-100*ratio+"%",top:0}):cb.css({top:100-100*ratio+"%",right:0}),cb.css({background:funcs.buildProcessBackground(color,ratio,dir),opacity:ratio<.9?.4:4*(1-ratio)}),cb.attr("data-ratio",ratio),cb.attr("data-direction",dir)}},funcs.buildProcessBackground=function(color,ratio,dir){return"linear-gradient("+("|"==dir?"0deg":"90deg")+", rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%)"},funcs.updateContent=function(el){var card=$(el),isDataUpdated=card.attr("data-changed");if(isDataUpdated||(isDataUpdated="true"),"false"!==isDataUpdated.toLowerCase()){var cashin=parseFloat(card.attr("data-in")),cnt=(parseFloat(card.attr("data-out")),card.children(".content"));if(0==cnt.length){var $cnt=$('<div class="content"></div>');card.append($cnt),cnt=$cnt}var caphead=cnt.children("h5");if(0==caphead.length){var $caphead=$("<h5></h5>");cnt.append($caphead),caphead=$caphead}var captext=card.attr("data-head");captext!=caphead.html()&&caphead.html(captext),caphead.fitText(.4,{maxFontSize:"14px"});var desctext=card.attr("data-desc"),desbox=cnt.children("p");if(0==desbox.length){var $desbox=$("<p></p>");cnt.append($desbox),desbox=$desbox}desbox!=desbox.html()&&desbox.html(desctext),desbox.fitText(.35,{maxFontSize:"16px"}),card.attr("data-changed","false")}},$(window).on("resize",function(){utils.meatureDoc(),$(".date-grid .card").each(function(){utils.meatureCard(this)})}),$(document).ready(function(){viewdata=funcs.buildCardsData(sampleData);var dynamicValue=0,dynamicTick=function(){var el=$(".date-grid .card.dynamic");el.attr("data-out",dynamicValue),(dynamicValue+=10)>220&&(dynamicValue=0),funcs.updateView(el),funcs.updateContent(el),setTimeout(dynamicTick,1e3)},days=[...Array(sampleData.monthMaxDate+1).keys()].splice(sampleData.monthStartDate),days_=[...Array(sampleData.monthStartDate).keys()].splice(1);days.map(function(x){return[sampleData.year,sampleData.month,x].join("/")}).concat(days_.map(function(x){return[sampleData.year,sampleData.month+1,x].join("/")})).map(function(x){var json=viewdata[x];json?funcs.updateData(void 0,json,{disabled:new Date(x)>new Date}):funcs.updateData(void 0,{list:[],srcKey:x,isCustom:!1,cashIn:0,cashOut:0,desc_land:"",desc_port:"",head_land:"",head_port:""},{disabled:!0})}),utils.meatureDoc(),$(".date-grid .card").each(function(){utils.meatureCard(this)}),setTimeout(dynamicTick,1e3)});